---

---

<div class="[perspective:1200px]">
  <div
    id="portraitCard"
    class="fixed hidden h-[480px] w-[380px] origin-center transition-transform duration-700 ease-out [transform-style:preserve-3d] lg:flex"
  >
    <!-- Front -->
    <div class="absolute inset-0 overflow-hidden rounded-3xl [backface-visibility:hidden]">
      <img
        src="/portrait.png"
        alt="Portrait of Angel Rodriguez"
        class="h-full w-full rounded-3xl object-cover shadow-xl"
      />
    </div>

    <!-- Back -->
    <div
      class="absolute inset-0 [transform:rotateY(180deg)] overflow-hidden rounded-3xl [backface-visibility:hidden]"
    >
      <img
        src="/card-back.jpg"
        alt="Card back"
        class="h-full w-full rounded-3xl object-cover shadow-xl"
      />
    </div>
  </div>
</div>

<script>
  import { section } from 'framer-motion/m';

  const section1 = document.querySelector('.section-1') as HTMLDivElement;
  const section2 = document.querySelector('.section-2') as HTMLDivElement;
  const section3 = document.querySelector('.section-3') as HTMLDivElement;
  const mainContainer = document.querySelector('#flip-scroll-container') as HTMLDivElement;
  const stopPosition = mainContainer.clientHeight - section2.clientHeight;
  let lastXPosition = 0;

  const card = document.getElementById('portraitCard') as HTMLElement;
  card.style.transform = `
        rotateY(${0}deg)
        translateX(${mainContainer.clientWidth / 2 - card.clientWidth / 2 - 28}px)
        translateY(${scrollY - 240 + section1.clientHeight / 2}px)
   `;

  function getRotation(scrollY: number) {
    const progress = (scrollY - section1.offsetTop) / (section2.offsetTop - section1.offsetTop);
    const clamped = Math.min(Math.max(progress, 0), 1);
    return clamped * 180;
  }

  function handleScroll() {
    const scrollY = window.scrollY;
    if (scrollY > 30 && scrollY <= section1.clientHeight) {
      card.style.transform = `translateX(${mainContainer.clientWidth / 2 - card.clientWidth / 2 + (scrollY / 4) * 2}px) translateY(${scrollY - 240 + section1.clientHeight / 2}px) rotateY(${getRotation(scrollY)}deg)`;
      if (scrollY <= section1.clientHeight && scrollY > section1.clientHeight - 10) {
        lastXPosition =
          mainContainer.clientWidth / 2 - card.clientWidth / 2 + (scrollY / 4) * 2 + 20;
      }
    } else if (scrollY > section1.clientHeight && scrollY <= stopPosition) {
      card.style.transform = `translateX(${lastXPosition}px) translateY(${scrollY - 240 + section1.clientHeight / 2}px) rotateY(${getRotation(scrollY)}deg)`;
    }
  }

  handleScroll();

  document.addEventListener('scroll', handleScroll);
</script>
